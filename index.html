<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿé™…äº‰éœ¸IIå›½æœå½•åƒä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f7f9fc;
            color: #333;
            text-align: center;
        }
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 30px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #1e8449;
            border-bottom: 2px solid #1e8449;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        input[type="file"] {
            display: none;
        }
        .custom-file-upload {
            border: 3px dashed #1e8449;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 40px;
            min-height: 150px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            color: #1e8449;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }
        .custom-file-upload:hover, .drag-over {
            background-color: #e8f8f5;
            border-color: #145b32;
        }
        #fileNameDisplay {
            margin-top: 10px;
            font-weight: normal;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        #processBtn {
            background-color: #3498db;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: background-color 0.3s;
            width: 80%;
        }
        #processBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #processBtn:hover:not(:disabled) {
            background-color: #2980b9;
        }
        #status {
            margin-top: 30px;
            padding: 15px;
            border-radius: 8px;
            min-height: 20px;
            font-weight: 500;
            text-align: left; /* æ‰¹é‡å¤„ç†çŠ¶æ€éœ€è¦å·¦å¯¹é½ */
        }
        .note {
            margin-top: 20px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>æ˜Ÿé™…äº‰éœ¸II å›½æœå½•åƒä¿®å¤</h1>
    <p>é€‚ç”¨äº SC2.5.0.15.X ç³»åˆ—ç‰ˆæœ¬(95687/95740..ç­‰)ï¼Œæ”¯æŒåŒæ—¶é€‰æ‹©/æ‹–æ‹½å¤šä¸ªæ–‡ä»¶è¿›è¡Œä¿®å¤ã€‚</p>
    <p>åŸç†ï¼š
    <label for="replayFile" class="custom-file-upload" id="dropArea">
        ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½ .SC2Replay æ–‡ä»¶åˆ°æ­¤
        <span id="fileNameDisplay">ï¼ˆæœªé€‰æ‹©æ–‡ä»¶ï¼‰</span>
    </label>
    <input type="file" id="replayFile" accept=".SC2Replay" multiple />
    
    <button id="processBtn" disabled>æ‰§è¡Œä¿®å¤å¹¶ä¸‹è½½å…¨éƒ¨æ–‡ä»¶</button>

    <div id="status"></div>
    <p class="note">âš ï¸ æœ¬å·¥å…·åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°æ‰§è¡Œæ“ä½œï¼Œæ–‡ä»¶ä¸ä¼šä¸Šä¼ è‡³ä»»ä½•æœåŠ¡å™¨ã€‚</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('replayFile');
    const processBtn = document.getElementById('processBtn');
    const statusDiv = document.getElementById('status');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const dropArea = document.getElementById('dropArea');
    let fileQueue = [];
    let processing = false;

    const searchBytes = new Uint8Array([0x09, 0x00, 0x04, 0x09, 0x00, 0x06, 0x09, 0x00]); 
    const targetBytes = new Uint8Array([0x09, 0x0A, 0x04, 0x09, 0x00, 0x06, 0x09, 0x1E]);
    const LENGTH = searchBytes.length;

    function findBytesOffset(buffer, searchBytes) {
        const view = new Uint8Array(buffer);
        const searchLen = searchBytes.length;
        const bufferLen = view.length;
        const scanLimit = Math.min(bufferLen, 128);

        for (let i = 0; i < scanLimit - searchLen + 1; i++) {
            let match = true;
            for (let j = 0; j < searchLen; j++) {
                if (view[i + j] !== searchBytes[j]) {
                    match = false;
                    break;
                }
            }
            if (match) {
                return i;
            }
        }
        return -1;
    }

    function updateFileDisplay() {
        if (fileQueue.length > 0) {
            fileNameDisplay.innerHTML = `å·²é€‰æ‹©æ–‡ä»¶æ•°é‡: <b>${fileQueue.length}</b><br>ç‚¹å‡» "æ‰§è¡Œä¿®å¤" å¼€å§‹æ‰¹é‡å¤„ç†ã€‚`;
            processBtn.disabled = false;

        } else {
            fileNameDisplay.textContent = 'ï¼ˆæœªé€‰æ‹©æ–‡ä»¶ï¼‰';
            processBtn.disabled = true;

        }
    }

    function addFilesToQueue(files) {
        let validFiles = Array.from(files).filter(file => file.name.toLowerCase().endsWith('.sc2replay'));
        
        if (validFiles.length > 0) {
            fileQueue = validFiles; 
            updateFileDisplay();


            statusDiv.textContent = ''; 
            statusDiv.style.backgroundColor = 'transparent';

        } else if (files.length > 0) {
            statusDiv.innerHTML = `âŒ æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„ .SC2Replay æ–‡ä»¶ã€‚`;
            statusDiv.style.backgroundColor = '#f8d7da';
            statusDiv.style.color = '#721c24';
        }
    }

    function processSingleFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();


            const lastModifiedDate = new Date(file.lastModified);
            const year = lastModifiedDate.getFullYear();

            const month = String(lastModifiedDate.getMonth() + 1).padStart(2, '0');
            const day = String(lastModifiedDate.getDate()).padStart(2, '0');
            const dateStr = `${year}${month}${day}`;


            reader.onload = function(e) {
                const buffer = e.target.result;
                
                try {
                    const offset = findBytesOffset(buffer, searchBytes);
                    let result;

                    if (offset === -1) {
                        result = { success: false, name: file.name, message: 'æœªæ‰¾åˆ°æŸåæ ‡è®°ã€‚' };
                    } else {
                        const newBuffer = buffer.slice(0); 
                        const newView = new Uint8Array(newBuffer);

                        for (let i = 0; i < LENGTH; i++) {
                            newView[offset + i] = targetBytes[i];
                        }

                        const fixedBlob = new Blob([newBuffer], { type: 'application/octet-stream' });
                        const url = URL.createObjectURL(fixedBlob);
                        const a = document.createElement('a');
                        a.href = url;


                        // updateï¼šMyReplay.SC2Replay -> MyReplay-20251201-FIXED.SC2Replay add:timestamp
                        const originalFileName = file.name.replace(/\.SC2Replay$/i, ''); 
                        const newFileName = `${originalFileName}-${dateStr}-FIXED.SC2Replay`;
                        
                        a.download = newFileName;
                        
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        result = { success: true, name: newFileName, message: `ä¿®å¤æˆåŠŸ (Offset: 0x${offset.toString(16).toUpperCase()})` };
                    }
                    resolve(result);
                } catch (error) {
                    reject({ success: false, name: file.name, message: `å¤„ç†å¤±è´¥: ${error.message}` });
                }
            };

            reader.onerror = function() {
                reject({ success: false, name: file.name, message: 'æ–‡ä»¶è¯»å–å¤±è´¥ã€‚' });
            };

            reader.readAsArrayBuffer(file);
        });
    }
    

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function processFileQueue() {
        if (processing || fileQueue.length === 0) return;

        processing = true;
        processBtn.disabled = true;
        

        statusDiv.style.backgroundColor = '#fff3cd';
        statusDiv.style.color = '#856404';
        

        const currentQueue = [...fileQueue];
        fileQueue = [];
        
        const totalFiles = currentQueue.length;
        statusDiv.innerHTML = `
            <h4>æ­£åœ¨è¿›è¡Œæ‰¹é‡ä¿®å¤...</h4>
            <div id="processingCurrent" style="margin-bottom: 10px; font-style: italic;"></div>
            <ul id="resultList" style="list-style-type: none; padding: 0; margin-top: 10px;">
                </ul>
        `;
        
        const processingCurrent = document.getElementById('processingCurrent');
        const resultList = document.getElementById('resultList');

        let successCount = 0;
        let failCount = 0;
        const DELAY_MS = 500; 

        for (let i = 0; i < totalFiles; i++) {
            const file = currentQueue[i];
            

            processingCurrent.textContent = `[${i + 1}/${totalFiles}] æ­£åœ¨å¤„ç†ï¼š${file.name} ...`;
            
            let result;
            try {
                result = await processSingleFile(file);
            } catch (error) {
                result = error;
            }
            

            const statusIcon = result.success ? 'ğŸŸ¢' : 'ğŸ”´';
            const statusStyle = result.success ? 'color: #155724;' : 'color: #721c24;';
            
            const li = document.createElement('li');
            li.style.cssText = statusStyle + 'margin-bottom: 5px;';
            li.innerHTML = `${statusIcon} <b>${result.name}</b> - ${result.message}`;
            resultList.appendChild(li);


            if (result.success) {
                successCount++;
            } else {
                failCount++;
            }
            
            await sleep(DELAY_MS); 
        }
        

        processingCurrent.remove(); 
        processing = false;
        

        statusDiv.style.backgroundColor = '#e0ffe0';
        statusDiv.style.color = '#155724';
        const finalStatusHtml = `
            <h4>âœ… æ‰¹é‡ä¿®å¤å®Œæˆï¼</h4>
            <p style="margin: 5px 0; font-size: 1.1em;">
                <span style="color: #155724;">æˆåŠŸ: <b>${successCount}</b> ä¸ª</span> | 
                <span style="color: #721c24;">å¤±è´¥: <b>${failCount}</b> ä¸ª</span>
            </p>
            <ul style="list-style-type: none; padding: 0; margin-top: 10px;">
                ${resultList.innerHTML} 
            </ul>
        `;

        statusDiv.innerHTML = finalStatusHtml;


        updateFileDisplay();
    }


    fileInput.addEventListener('change', (event) => {

        fileQueue = [];
        addFilesToQueue(event.target.files);
    });

    dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('drag-over');
    });

    dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('drag-over');
    });

    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {

            fileQueue = [];
            addFilesToQueue(e.dataTransfer.files);
        }
    });

    processBtn.addEventListener('click', processFileQueue);
});
</script>

</body>
</html>
